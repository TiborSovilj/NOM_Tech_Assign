////////////////////////////////////////////////////////////////////////////////
// COPYRIGHT (c) 2023
// NOMNIO d.o.o.
// All rights reserved.
////////////////////////////////////////////////////////////////////////////////
/**
 *	@file		main.c
 *	@author   	Tibor Sovilj
 *	@date		12.10.2023
 *	@version	V1.0.0

 *	@brief 		Main source file.
 */
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
/**
 *	@addtogroup MAIN
 *	@{ <!-- BEGIN GROUP -->
 */
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Includes
////////////////////////////////////////////////////////////////////////////////
#include <stdio.h>
#include <stdio.h>
#include <stdint.h>
#include <stddef.h>
#include <string.h>

#include "nvs_flash.h"
#include "esp_log.h"
#include "esp_wifi.h"
#include "esp_system.h"
#include "esp_event.h"
#include "esp_netif.h"
#include "mqtt_client.h"
#include "esp_tls.h"

#include "../protocols/wifi/lib/wifi.h"
#include "../protocols/sntp/lib/sntp.h"
#include "../protocols/mqtt/lib/mqtt.h"
#include "../drivers/devices/DHT22/lib/DHT22.h"
#include "../drivers/devices/irq_button/lib/irq_button.h"

////////////////////////////////////////////////////////////////////////////////
// Definitions
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Typedefs
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Global Variables
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Function Prototypes
////////////////////////////////////////////////////////////////////////////////
void wifi_connected_event(void);


////////////////////////////////////////////////////////////////////////////////
// MAIN FUNCTION
////////////////////////////////////////////////////////////////////////////////

void app_main(void)
{
    // Initialize NVS
	esp_err_t ret = nvs_flash_init();
	if (ret == ESP_ERR_NVS_NO_FREE_PAGES || ret == ESP_ERR_NVS_NEW_VERSION_FOUND)
	{
		ESP_ERROR_CHECK(nvs_flash_erase());
		ret = nvs_flash_init();
	}
	ESP_ERROR_CHECK(ret);

	wifi_app_start();                               // Start Wifi AP.
	dht22_task_start();                             // Start DHT.
	wifi_app_set_callback(&wifi_connected_event);   // Callback after the WiFi STA is connected.
}


////////////////////////////////////////////////////////////////////////////////
// Function Definitions
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
/**
 * @brief 	Function that starts SNTP task and is used as callback function
 * 			to an eWIFI_APP_MSG_STA_CONNECTED_GOT_IP event
 * 
 * @return voID
 */
////////////////////////////////////////////////////////////////////////////////
void wifi_connected_event(void)
{
	printf("WiFi STA Connected!");
	sntp_task_start();                              // Start SNTP.
	mqtt_app_start();                               // Start MQTT.
    irq_button_config();                            // Enable interrupt button
}


////////////////////////////////////////////////////////////////////////////////
/**
 *	@} <!-- END GROUP -->
 */
////////////////////////////////////////////////////////////////////////////////

