////////////////////////////////////////////////////////////////////////////////
// COPYRIGHT (c) 2023
// NOMNIO d.o.o.
// All rights reserved.
////////////////////////////////////////////////////////////////////////////////
/**
 *	@file		irq_button.c
 *	@author   	Tibor Sovilj
 *	@date		25.10.2023
 *	@version	V0.0.1

 *	@brief 		Source file for the interrupt user button.  
 */
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
/**
 *	@addtogroup IRQ_BUTTON_STATIC
 *	@{ <!-- BEGIN GROUP -->
 */
////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////
// Includes
////////////////////////////////////////////////////////////////////////////////
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "freertos/semphr.h"
#include "driver/gpio.h"
#include "esp_log.h"

#include "../../protocols/mqtt/lib/mqtt.h"
#include "../../project_config.h"

#include "irq_button.h"
#include "../config/irq_button_cfg.h"

////////////////////////////////////////////////////////////////////////////////
// Definitions
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Static Typedefs
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Static Global Variables
////////////////////////////////////////////////////////////////////////////////

// Semaphore handle
SemaphoreHandle_t irq_button_semaphore = NULL;


////////////////////////////////////////////////////////////////////////////////
// Static Function Prototypes
////////////////////////////////////////////////////////////////////////////////
void 			irq_button_task			(void *pvParam);
void IRAM_ATTR 	irq_button_isr_handler	(void *arg);
void 			irq_button_gpio_init	(void);

////////////////////////////////////////////////////////////////////////////////
// Static Function Definitions
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
/**
 * @brief 		ISR handler for the button.
 * 
 * @param[in] 	arg 	parameter which can be passed to the ISR handler.
 * @return		void
 */
////////////////////////////////////////////////////////////////////////////////
void IRAM_ATTR irq_button_isr_handler(void *arg)
{
	// Notify the button task
	xSemaphoreGiveFromISR(irq_button_semaphore, NULL);
}

////////////////////////////////////////////////////////////////////////////////
/**
 * @brief 		=== add
 * 
 * @param[in] 	pvParam 	parameter which can be passed to the task.
 * @return 		void
 */
////////////////////////////////////////////////////////////////////////////////
void irq_button_task(void *pvParam)
{
	while (1)
	{
		if (xSemaphoreTake(irq_button_semaphore, portMAX_DELAY) ==  pdTRUE)
		{
			printf("BUTTON INTERRUPT OCCURRED\n");

			// Prompt MQTT client to publish the payload
			mqtt_send_signal_message(eMQTT_SIGNAL_MSG_BUTTON_IT);

			// Second delay to eliminate button bouncing and sporadic presses-
			vTaskDelay(1000 / portTICK_PERIOD_MS);
		}
	}
}

/**
 * @brief 	Interrupt button configuration
 * 
 * @return	void
 */
void irq_button_gpio_init(void)
{
	esp_rom_gpio_pad_select_gpio	(IRQ_BUTTON_GPIO);
	gpio_set_direction				(IRQ_BUTTON_GPIO, GPIO_MODE_INPUT);
	gpio_set_intr_type				(IRQ_BUTTON_GPIO, GPIO_INTR_NEGEDGE);
}
////////////////////////////////////////////////////////////////////////////////
/**
 *	@} <!-- END GROUP -->
 */
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
/**
 *	@addtogroup IRQ_BUTTON_API
 *	@{ <!-- BEGIN GROUP -->
 */
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// API Function Definitions
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
/**
 * @brief   Configures irq button and interrupt configuration
 * 
 * @return  void
 */
////////////////////////////////////////////////////////////////////////////////
void irq_button_config(void)
{
	// Create the binary semaphore
	irq_button_semaphore = xSemaphoreCreateBinary();

	// Initialize button GPIO
	irq_button_gpio_init();

	// Create the irq button task
	xTaskCreate(irq_button_task, "irq_button_task", IRQ_BUTTON_TASK_STACK_SIZE, NULL, IRQ_BUTTON_TASK_PRIORITY, NULL);

	// Install/Enable gpio ISR service
	gpio_install_isr_service(IRQ_BUTTON_FLAG_DEFAULT);

	// Attach the interrupt service routine
	gpio_isr_handler_add(IRQ_BUTTON_GPIO, irq_button_isr_handler, NULL);
}

////////////////////////////////////////////////////////////////////////////////
/**
 * @brief   Start funciton for th MQTT protocol
 * 
 * @return  void
 */
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
/**
 *	@} <!-- END GROUP -->
 */
////////////////////////////////////////////////////////////////////////////////
